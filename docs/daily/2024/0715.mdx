import Logbook  from '../../componet/Logbook';

# 07æœˆ15å·

## æ—¥ç¨‹åˆ—è¡¨ ğŸ“…

<Logbook>
      <Logbook.TaskItem isComplete={true}>èƒŒè¯µ20ä¸ªè‹±è¯­å•è¯</Logbook.TaskItem>
      <Logbook.TaskItem isComplete={false}>å­¦ä¹ solidityåŸºç¡€ç¬¬ä¸‰ç« </Logbook.TaskItem>
      <Logbook.TaskItem isComplete={true}>Javaé¢è¯•é¢˜ç›®</Logbook.TaskItem>
</Logbook>

## ğŸ“˜ Javaé¢è¯•é¢˜ç›®

## â“ é¢˜ç›®ä¸€

å·²çŸ¥ç³»ç»Ÿä¸­å®ç°äº†â¼€ç³»åˆ—åˆ†â»šæ¥â¼ï¼Œå½¢å¦‚ï¼š

```Java
RpcResponse<List<MetricXxxDTO> listMetrics(MetricXxxQuery query);
RpcResponse<List<MetricYyyDTO> listMetrics(MetricYyyQuery query);
RpcResponse<List<MetricZzzDTO> listMetrics(MetricZzzQuery query);
```
å…¶ä¸­ï¼š

```Java
@Data
class RpcResponse<T> {
private Boolean success;
private T data;
// åˆ†â»šä»¤ç‰Œï¼Œå¦‚æœè¿”å›å€¼ä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡è¯¥ä»¤ç‰Œèƒ½å¤Ÿæ‰§â¾ä¸‹â¼€æ¬¡æŸ¥è¯¢
private byte[] token;
}
@Data
abstract class BaseMetericQuery {
private byte[] token;
}
class MetricXxxQuery extends BaseMetericQuery {
// æŸ¥è¯¢å­—æ®µ
}
class MetricYyyQuery extends BaseMetericQuery {
// æŸ¥è¯¢å­—æ®µ
}
class MetricZzzQuery extends BaseMetericQuery {
// æŸ¥è¯¢å­—æ®µ
}
```

ç”±äºå•æ¬¡åˆ†â»šæ¥â¼è°ƒâ½¤ä»…èƒ½è¿”å›æœ€å¤š 200 æ¡æ•°æ®ï¼Œä¸ºäº†è·å–æŸ¥è¯¢èŒƒå›´å†…çš„å…¨é‡æ•°æ®ã€‚
è¯·å®ç°â¾ƒåŠ¨åˆ†â»šçš„é™æ€â½…æ³• MetricQueryPager.autoPaged ã€‚

### ğŸ“ æˆ‘çš„ç­”æ¡ˆ

```Java
import java.util.ArrayList;
import java.util.List;

public class MetricQueryPager {

    public static <T, Q extends BaseMetericQuery> List<T> autoPaged(MetricQueryExecutor<T, Q> executor, Q query) {
        List<T> allData = new ArrayList<>();
        byte[] token = null;

        do {
            query.setToken(token);
            RpcResponse<List<T>> response = executor.execute(query);

            if (response.getSuccess() && response.getData() != null) {
                allData.addAll(response.getData());
                token = response.getToken();
            } else {
                token = null; // åœæ­¢åˆ†é¡µ
            }
        } while (token != null && token.length > 0);

        return allData;
    }

    // å®šä¹‰ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œç”¨äºæ‰§è¡Œä¸åŒç±»å‹çš„æŸ¥è¯¢
    @FunctionalInterface
    public interface MetricQueryExecutor<T, Q> {
        RpcResponse<List<T>> execute(Q query);
    }
}
```
### ğŸ“‹ ä½¿ç”¨æ–¹æ³•:

```Java
public class Main {
    public static void main(String[] args) {
        MetricXxxQuery query = new MetricXxxQuery();
        List<MetricXxxDTO> allMetrics = MetricQueryPager.autoPaged(
            q -> listMetrics((MetricXxxQuery) q),
            query
        );
        // å¤„ç†allMetrics
    }

    public static RpcResponse<List<MetricXxxDTO>> listMetrics(MetricXxxQuery query) {
        // å®ç°å®é™…çš„æŸ¥è¯¢é€»è¾‘
        // è¿™é‡Œå¯ä»¥è°ƒç”¨å®é™…çš„RPCæ¥å£
        return new RpcResponse<>();
    }
}
```

### ğŸ’¡ è®¾è®¡æ€è·¯

- æ³›å‹æ–¹æ³•ï¼š`autoPaged` æ–¹æ³•ä½¿ç”¨æ³›å‹ `<T, Q>` æ¥é€‚åº”ä¸åŒçš„ `DTO` å’Œ `Query` ç±»å‹ã€‚
- åˆ†é¡µå¤„ç†ï¼šé€šè¿‡æ£€æŸ¥è¿”å›ç»“æœä¸­çš„åˆ†é¡µä»¤ç‰Œ`token`ï¼Œæ¥å†³å®šæ˜¯å¦ç»§ç»­æ‰§è¡Œåç»­æŸ¥è¯¢ã€‚
- å‡½æ•°å¼æ¥å£ï¼šå®šä¹‰äº†ä¸€ä¸ªå‡½æ•°å¼æ¥å£ `MetricQueryExecutor`ï¼Œç”¨äºä¼ é€’ä¸åŒçš„æŸ¥è¯¢æ‰§è¡Œé€»è¾‘ã€‚è¿™ä½¿å¾— `autoPaged` æ–¹æ³•å¯ä»¥ä¸å„ç§ç±»å‹çš„æŸ¥è¯¢é…åˆä½¿ç”¨ã€‚


## â“ é¢˜ç›®äºŒ
æ ¹æ®ç”µâ½¹çš„è´Ÿè·å˜åŒ–æƒ…å†µï¼Œæ¯å¤© 24 â¼©æ—¶ä¼šåˆ’åˆ†ä¸ºå°–ï¼ˆCritical Peakï¼‰ã€å³°ï¼ˆPeakï¼‰ã€å¹³
ï¼ˆShoulderï¼‰ã€â¾•ï¼ˆOff Peakï¼‰å¤šä¸ªæ—¶æ®µï¼Œå„æ—¶æ®µä¼šé‡‡â½¤ä¸åŒçš„ç”µä»·ã€‚å›½å®¶ç”µâ½¹ä¼šæŒ‰â½‰è°ƒæ•´æ—¶æ®µä¸ç›¸
åº”çš„ç”µä»·ã€‚æŸä¸ªâ½‰çš„æ—¶æ®µä¸ç”µä»·å¦‚ä¸‹æ‰€â½°ï¼š

```json
1 00:00:00ã€œ06:00:00 | â¾• | Â¥0.31
2 06:00:00ã€œ08:00:00 | å¹³ | Â¥0.76
3 08:00:00ã€œ12:00:00 | å³° | Â¥0.92
4 12:00:00ã€œ14:00:00 | å°– | Â¥1.20
5 14:00:00ã€œ15:00:00 | å³° | Â¥0.92
6 15:00:00ã€œ18:00:00 | å¹³ | Â¥0.76
7 18:00:00ã€œ21:00:00 | å³° | Â¥0.92
8 21:00:00ã€œ22:00:00 | å¹³ | Â¥0.76
9 22:00:00ã€œ00:00:00 | â¾• | Â¥0.31
```

å·²çŸ¥æœ‰â¼€æ¬¾ 100 kWh å®¹é‡ï¼ˆcapacityï¼‰ï¼Œ50 kW æ ‡å‡†åŠŸç‡ï¼ˆstandardPowerï¼‰çš„å……ç”µå®ï¼Œé€šè¿‡åœ¨â¾•æ®µ
å……ç”µï¼ˆchargeï¼‰å’Œå³°æ®µæ”¾ç”µï¼ˆdischargeï¼‰çš„â½…å¼ï¼Œèƒ½å¤Ÿèµšå–ç”µè´¹å·®ä»·ã€‚
æ³¨ï¼šå……ç”µå®å……ç”µä¸æ”¾ç”µåŠŸç‡çš„æ ‡å‡†åŠŸç‡å‡ä¸º 50 kWï¼Œå³æŒ‰ç…§æ ‡å‡†åŠŸç‡ï¼Œä¸¤ä¸ªâ¼©æ—¶ä»é›¶ç”µé‡å……æ»¡æˆ–æ»¡ç”µ
é‡æ”¾å®Œã€‚

```java
/**
* å³°â¾•æ—¶æ®µé…ç½®
*/
record TouPeriodDTO(TouState state, LocalTime startTime, LocalTime endTime) {
}
/**
* å³°â¾•ç”µä»·é…ç½®
*/
record TouPriceDTO(TouState state, Double price) {
}
/**
* å•â½‡å³°â¾•æ—¶æ®µä¸ç”µä»·é…ç½®
*/
record TouDTO(LocalDate date, Set<TouPeriodDTO> periods, Set<TouPriceDTO>
prices) {
}

/**
* å……ç”µå®çš„å……æ”¾æŒ‡ä»¤
*/
@Data
class DispatchCommand {
      private LocalTime startTime;
      private LocalTime endTime;
      // æ­£æ•°è¡¨â½°å……ç”µï¼Œè´Ÿæ•°è¡¨â½°æ”¾ç”µ
      private Double power;
}

/**
* è®¾å¤‡å‚æ•°
*/
record DeviceSpecDTO(Double capacity, Double standardPower) {
}

/**
* å……æ”¾è°ƒåº¦çš„ä¸Šä¸‹â½‚
*/
record DispatchContext(TouDTO touDTO, DeviceSpecDTO deviceSpecDTO) {
}

```
è¯·å®ç°æ¥â¼ï¼Œä»¥å¾—åˆ°å•â½‡æœ€â¼¤æ”¶ç›Šçš„å……æ”¾æŒ‡ä»¤åˆ—è¡¨ã€‚
`List<DispatchCommand> dispatch(DispatchContext context);`

- æâ½°â¼€ï¼šä»¥ã€Œè¾“å‡ºâ¼€å¤©çš„å……æ”¾è®¡åˆ’ã€ä¸ºâ½¬æ ‡ï¼Œä¸éœ€è¦è€ƒè™‘â»“å‘¨æœŸçš„ä¼˜åŒ–ç­–ç•¥ã€‚
- æâ½°â¼†ï¼šâ½†éœ€è€ƒè™‘è®¾å¤‡è¿â¾çš„æŸè€—ã€‚
- æâ½°ä¸‰ï¼šâ½†éœ€è€ƒè™‘è®¾å¤‡è¿‡å……ï¼ˆè®¾å¤‡æ»¡ç”µåç»§ç»­å……ç”µï¼‰å’Œè¿‡æ”¾ï¼ˆè®¾å¤‡äºç”µåç»§ç»­æ”¾ç”µï¼‰çš„é—®é¢˜ã€‚
è¾“å‡ºç»“æœçš„æ ·ä¾‹ï¼š

```json
DispatchCommand(startTime=00:00, endTime=06:00, activePower=50)
DispatchCommand(startTime=12:00, endTime=14:00, activePower=-50)
DispatchCommand(startTime=15:00, endTime=18:00, activePower=50)
DispatchCommand(startTime=18:00, endTime=21:00, activePower=-50)
```

### âš¡ å……æ”¾ç”µè°ƒåº¦

```java
    public List<DispatchCommand> dispatch(DispatchContext context) {
        List<DispatchCommand> commands = new ArrayList<>();
        TouDTO touDTO = context.touDTO();
        DeviceSpecDTO deviceSpecDTO = context.deviceSpecDTO();
        Double standardPower = deviceSpecDTO.standardPower();

        // è§£æå³°è°·æ—¶æ®µ
        Set<TouPeriodDTO> periods = touDTO.periods();
        // è§£æç”µä»·
        Set<TouPriceDTO> prices = touDTO.prices();

        // æ‰¾åˆ°æœ€ä½ç”µä»·çš„æ—¶é—´æ®µï¼ˆå……ç”µï¼‰
        TouPeriodDTO chargePeriod = null;
        double minPrice = Double.MAX_VALUE;
        for (TouPeriodDTO period : periods) {
            for (TouPriceDTO price : prices) {
                if (period.state().equals(price.state()) && price.price() < minPrice) {
                    minPrice = price.price();
                    chargePeriod = period;
                }
            }
        }

        // æ‰¾åˆ°æœ€é«˜ç”µä»·çš„æ—¶é—´æ®µï¼ˆæ”¾ç”µï¼‰
        TouPeriodDTO dischargePeriod = null;
        double maxPrice = Double.MIN_VALUE;
        for (TouPeriodDTO period : periods) {
            for (TouPriceDTO price : prices) {
                if (period.state().equals(price.state()) && price.price() > maxPrice) {
                    maxPrice = price.price();
                    dischargePeriod = period;
                }
            }
        }

        // ç”Ÿæˆå……ç”µæŒ‡ä»¤
        if (chargePeriod != null) {
            commands.add(new DispatchCommand(chargePeriod.startTime(), chargePeriod.endTime(), standardPower));
        }

        // ç”Ÿæˆæ”¾ç”µæŒ‡ä»¤
        if (dischargePeriod != null) {
            commands.add(new DispatchCommand(dischargePeriod.startTime(), dischargePeriod.endTime(), -standardPower));
        }

        return commands;
    }
```

### ğŸ“‹ ä½¿ç”¨æ–¹æ³•:

``` java
public static void main(String[] args) {
        // ç¤ºä¾‹æ•°æ®
        Set<TouPeriodDTO> periods = Set.of(
                new TouPeriodDTO(TouState.OFF_PEAK, LocalTime.of(0, 0), LocalTime.of(6, 0)),
                new TouPeriodDTO(TouState.SHOULDER, LocalTime.of(6, 0), LocalTime.of(8, 0)),
                new TouPeriodDTO(TouState.PEAK, LocalTime.of(8, 0), LocalTime.of(12, 0)),
                new TouPeriodDTO(TouState.CRITICAL_PEAK, LocalTime.of(12, 0), LocalTime.of(14, 0)),
                new TouPeriodDTO(TouState.PEAK, LocalTime.of(14, 0), LocalTime.of(15, 0)),
                new TouPeriodDTO(TouState.SHOULDER, LocalTime.of(15, 0), LocalTime.of(18, 0)),
                new TouPeriodDTO(TouState.PEAK, LocalTime.of(18, 0), LocalTime.of(21, 0)),
                new TouPeriodDTO(TouState.SHOULDER, LocalTime.of(21, 0), LocalTime.of(22, 0)),
                new TouPeriodDTO(TouState.OFF_PEAK, LocalTime.of(22, 0), LocalTime.of(0, 0))
        );

        Set<TouPriceDTO> prices = Set.of(
                new TouPriceDTO(TouState.OFF_PEAK, 0.31),
                new TouPriceDTO(TouState.SHOULDER, 0.76),
                new TouPriceDTO(TouState.PEAK, 0.92),
                new TouPriceDTO(TouState.CRITICAL_PEAK, 1.20)
        );

        TouDTO touDTO = new TouDTO(LocalDate.now(), periods, prices);
        DeviceSpecDTO deviceSpecDTO = new DeviceSpecDTO(100.0, 50.0);
        DispatchContext context = new DispatchContext(touDTO, deviceSpecDTO);

        List<DispatchCommand> commands = dispatch(context);
        for (DispatchCommand command : commands) {
            System.out.println(command);
        }
    }
```

### ğŸ’¡ è®¾è®¡æ€è·¯

- è§£ææ—¶æ®µå’Œç”µä»·ä¿¡æ¯ï¼šå°†ç»™å®šçš„å³°è°·æ—¶æ®µå’Œç”µä»·ä¿¡æ¯è§£æå‡ºæ¥ï¼Œä»¥ä¾¿åç»­å¤„ç†ã€‚
- ç¡®å®šå……ç”µå’Œæ”¾ç”µçš„æ—¶æ®µï¼šåŸºäºç”µä»·ä¿¡æ¯ï¼Œé€‰æ‹©ç”µä»·æœ€ä½çš„æ—¶æ®µå……ç”µï¼Œç”µä»·æœ€é«˜çš„æ—¶æ®µæ”¾ç”µã€‚
- ç”Ÿæˆè°ƒåº¦æŒ‡ä»¤ï¼šæ ¹æ®å……ç”µå®çš„æ ‡å‡†åŠŸç‡å’Œå®¹é‡ï¼Œç”Ÿæˆå¯¹åº”çš„å……æ”¾ç”µè°ƒåº¦æŒ‡ä»¤ã€‚
- è§£æè¾“å…¥æ•°æ®ï¼šä» DispatchContext ä¸­è·å–å³°è°·æ—¶æ®µé…ç½®å’Œç”µä»·é…ç½®ã€‚
- é€‰æ‹©å……ç”µå’Œæ”¾ç”µæ—¶æ®µï¼šæ‰¾åˆ°æœ€ä½ç”µä»·çš„æ—¶æ®µç”¨äºå……ç”µï¼Œæœ€é«˜ç”µä»·çš„æ—¶æ®µç”¨äºæ”¾ç”µã€‚
- ç”Ÿæˆè°ƒåº¦æŒ‡ä»¤ï¼šæ ¹æ®æ ‡å‡†åŠŸç‡ç”Ÿæˆå……ç”µå’Œæ”¾ç”µæŒ‡ä»¤ã€‚

## ğŸ“ æ€»ç»“ï¼š

- é€šè¿‡æ³›å‹å’Œå‡½æ•°å¼æ¥å£å®ç°äº†è‡ªåŠ¨åˆ†é¡µçš„æ–¹æ³•ï¼Œç¡®ä¿é€‚ç”¨å„ç§ä¸åŒçš„æŸ¥è¯¢ç±»å‹ã€‚
- åˆ†æå¹¶å®ç°äº†å……ç”µå®åœ¨å•æ—¥å†…çš„æœ€ä½³å……æ”¾ç”µç­–ç•¥ï¼Œæœ€å¤§åŒ–æ”¶ç›Šã€‚

## ğŸ“Œ å…³é”®ç‚¹ï¼š

- æ³›å‹ç¼–ç¨‹
- åˆ†é¡µå¤„ç†é€»è¾‘
- å‡½æ•°å¼æ¥å£çš„ä½¿ç”¨
- å……æ”¾ç”µè°ƒåº¦ç­–ç•¥çš„è®¾è®¡
- æ•°æ®è§£æä¸å¤„ç†